upstream automaking_app {
    server unix:/var/www/automaking/gunicorn.sock fail_timeout=0;
}

# HTTP 서버 (항상 활성화)
server {
    listen 80;
    listen [::]:80;
    server_name _;  # 모든 도메인/IP 허용 (실제 배포 시 도메인으로 변경)

    # Let's Encrypt 인증서 발급을 위한 경로
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 최대 업로드 크기 (오디오 파일 고려)
    client_max_body_size 50M;

    # 로그 파일
    access_log /var/www/automaking/logs/nginx-access.log;
    error_log /var/www/automaking/logs/nginx-error.log;

    # 정적 파일 (collectstatic으로 수집된 CSS, JS 등)
    location /static/ {
        alias /var/www/automaking/static/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin *;
    }

    # 미디어 파일 (Supabase Storage 사용 시 Django가 signed URL 반환)
    location /media/ {
        alias /var/www/automaking/media/;
        expires 7d;
        add_header Cache-Control "public";
    }

    # Django 애플리케이션
    location / {
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Host $http_host;
        proxy_redirect off;
        proxy_buffering off;

        # WebSocket 지원 (필요시)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 타임아웃 설정 (오디오 생성 시간 고려)
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;

        proxy_pass http://automaking_app;
    }

    # 보안 헤더
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # gzip 압축
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/x-javascript application/xml+rss 
               application/javascript application/json 
               application/xml image/svg+xml;
    gzip_disable "msie6";
}

# HTTPS 설정은 Certbot이 자동으로 추가합니다
# sudo certbot --nginx 실행 후 이 파일에 HTTPS 블록이 자동으로 추가됩니다

# 아래는 삭제된 내용입니다 - Certbot이 자동으로 생성합니다
# 
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;

#     ... (Certbot이 자동으로 추가함)
# }
