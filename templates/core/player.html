{% extends 'base.html' %}

{% block title %}오디오 플레이어 - AutoMaking{% endblock %}

{% block content %}
<style>
        .player-container {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        #audio-player {
            width: 100%;
        }
        
        /* (버튼 제거) 플레이어는 키보드 화살표로 제어합니다. */

        #sentence-display {
            min-height: 100px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
            margin-top: 1rem; /* 버튼과의 간격 확보 */
        }
        #original-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        #translated-text {
            font-size: 1rem;
            color: #666;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1>음성 학습</h1>
        <audio id="audio-player" controls>
            <source src="{{ audio_data_uri }}" type="audio/mpeg">
            브라우저가 오디오 요소를 지원하지 않습니다.
        </audio>

        <!-- 5초 이동 버튼 제거: 왼쪽/오른쪽 화살표 키로 -10s/+10s 이동하여 재생합니다 -->

        <div id="sentence-display">
            <p id="original-text">오디오를 재생하세요.</p>
            <p id="translated-text"></p>
        </div>
    </div>

    <script>
        // Django 뷰에서 전달된 JSON 데이터를 JavaScript 객체로 파싱
        const syncData = JSON.parse('{{ sync_data_json|escapejs }}');
        
        // HTML 요소 가져오기
        const audioPlayer = document.getElementById('audio-player');
        const originalTextElem = document.getElementById('original-text');
        const translatedTextElem = document.getElementById('translated-text');
        

        // 키보드 좌/우 화살표로 -10초/+10초 이동하고 재생 (더 안정적 처리)
        document.addEventListener('keydown', (e) => {
            // 텍스트 입력 필드나 편집 가능한 요소에 포커스가 있으면 키 동작을 방지
            const tag = e.target && e.target.tagName;
            if (tag === 'INPUT' || tag === 'TEXTAREA' || e.target.isContentEditable) return;

            const isLeft = e.key === 'ArrowLeft' || e.key === 'Left' || e.keyCode === 37;
            const isRight = e.key === 'ArrowRight' || e.key === 'Right' || e.keyCode === 39;
            if (!isLeft && !isRight) return;

            e.preventDefault();
            const cur = Number.isFinite(audioPlayer.currentTime) ? audioPlayer.currentTime : 0;

            if (isLeft) {
                const newTime = Math.max(0, cur - 10);
                audioPlayer.currentTime = newTime;
                audioPlayer.play();
            } else if (isRight) {
                let newTime = cur + 10;
                if (Number.isFinite(audioPlayer.duration)) {
                    newTime = Math.min(audioPlayer.duration, newTime);
                }
                audioPlayer.currentTime = newTime;
                audioPlayer.play();
            }
        });

        let currentSentenceIndex = -1; // 현재 활성화된 문장의 인덱스 추적

        // 오디오 재생 시간이 업데이트될 때마다 실행되는 이벤트 리스너
        audioPlayer.addEventListener('timeupdate', () => {
            const currentTime = audioPlayer.currentTime;
            
            // 현재 재생 시간에 맞는 문장을 찾기
            const activeSentenceIndex = syncData.findIndex(item => 
                currentTime >= item.start && currentTime < item.end
            );

            // 현재 문장이 변경되었을 때만 화면 업데이트 (효율성)
            if (activeSentenceIndex !== -1 && activeSentenceIndex !== currentSentenceIndex) {
                const sentence = syncData[activeSentenceIndex];
                originalTextElem.textContent = sentence.text;
                translatedTextElem.textContent = `(${sentence.translation})`;
                currentSentenceIndex = activeSentenceIndex;
            }
        });

        // 오디오 재생이 끝나면 텍스트 초기화
        audioPlayer.addEventListener('ended', () => {
            originalTextElem.textContent = '재생 완료!';
            translatedTextElem.textContent = '다시 재생하려면 처음으로 이동하세요.';
            currentSentenceIndex = -1;
        });
        
        // 버튼 클릭 이벤트 관련 코드를 제거했습니다. 키보드로 제어하세요.
    </script>
{% endblock %}