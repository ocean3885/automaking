<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오디오 플레이어</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }
        .player-container {
            width: 90%;
            max-width: 600px;
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        #audio-player {
            width: 100%;
        }
        
        /* 💡 [CSS 추가] 버튼을 담을 컨테이너 */
        .controls-container {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        /* 💡 [CSS 추가] 버튼 스타일 */
        .controls-container button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
        }
        .controls-container button:hover {
            background-color: #0056b3;
        }

        #sentence-display {
            min-height: 100px;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
            margin-top: 1rem; /* 버튼과의 간격 확보 */
        }
        #original-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        #translated-text {
            font-size: 1rem;
            color: #666;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="player-container">
        <h1>음성 학습</h1>
        <audio id="audio-player" controls>
            <source src="{{ audio_data_uri }}" type="audio/mpeg">
            브라우저가 오디오 요소를 지원하지 않습니다.
        </audio>

        <div class="controls-container">
            <button id="skip-backward-btn">&laquo; 5초 뒤로</button>
            <button id="skip-forward-btn">5초 앞으로 &raquo;</button>
        </div>

        <div id="sentence-display">
            <p id="original-text">오디오를 재생하세요.</p>
            <p id="translated-text"></p>
        </div>
    </div>

    <script>
        // Django 뷰에서 전달된 JSON 데이터를 JavaScript 객체로 파싱
        const syncData = JSON.parse('{{ sync_data_json|escapejs }}');
        
        // HTML 요소 가져오기
        const audioPlayer = document.getElementById('audio-player');
        const originalTextElem = document.getElementById('original-text');
        const translatedTextElem = document.getElementById('translated-text');
        
        // 💡 [JS 추가] 5초 이동 버튼 요소 가져오기
        const skipBackwardBtn = document.getElementById('skip-backward-btn');
        const skipForwardBtn = document.getElementById('skip-forward-btn');

        let currentSentenceIndex = -1; // 현재 활성화된 문장의 인덱스 추적

        // 오디오 재생 시간이 업데이트될 때마다 실행되는 이벤트 리스너
        audioPlayer.addEventListener('timeupdate', () => {
            const currentTime = audioPlayer.currentTime;
            
            // 현재 재생 시간에 맞는 문장을 찾기
            const activeSentenceIndex = syncData.findIndex(item => 
                currentTime >= item.start && currentTime < item.end
            );

            // 현재 문장이 변경되었을 때만 화면 업데이트 (효율성)
            if (activeSentenceIndex !== -1 && activeSentenceIndex !== currentSentenceIndex) {
                const sentence = syncData[activeSentenceIndex];
                originalTextElem.textContent = sentence.text;
                translatedTextElem.textContent = `(${sentence.translation})`;
                currentSentenceIndex = activeSentenceIndex;
            }
        });

        // 오디오 재생이 끝나면 텍스트 초기화
        audioPlayer.addEventListener('ended', () => {
            originalTextElem.textContent = '재생 완료!';
            translatedTextElem.textContent = '다시 재생하려면 처음으로 이동하세요.';
            currentSentenceIndex = -1;
        });
        
        // 💡 [JS 추가] 5초 뒤로 가기 버튼 클릭 이벤트
        skipBackwardBtn.addEventListener('click', () => {
            // 현재 시간에서 5초를 빼고, 0초 미만으로 내려가지 않도록 설정
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
        });

        // 💡 [JS 추가] 5초 앞으로 가기 버튼 클릭 이벤트
        skipForwardBtn.addEventListener('click', () => {
            // 오디오의 전체 길이(duration)를 알고 있을 때만 최대값 제한
            if (audioPlayer.duration) {
                // 현재 시간에서 5초를 더하고, 전체 길이를 넘지 않도록 설정
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
            } else {
                // duration 로드 전이면 일단 5초 더하기
                audioPlayer.currentTime += 5;
            }
        });
    </script>
</body>
</html>