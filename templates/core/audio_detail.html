{% extends 'base.html' %}

{% load static %}

{% block title %}{{ audio.title }} - AutoMaking{% endblock %}

{% block extra_css %}
<style>
    /* ì œëª© í¸ì§‘ ì‹œ ë§ˆìš°ìŠ¤ ì˜¤ë²„ ìŠ¤íƒ€ì¼ */
    .title-editable:hover {
        text-decoration: underline;
    }

    /* ë¬¸ì¥ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
    .sentence-item {
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: background-color 180ms ease, transform 120ms ease;
    }

    .sentence-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
    }

    .sentence-item .original {
        color: #333;
        font-weight: normal;
    }

    /* í™œì„± ë¬¸ì¥ ìŠ¤íƒ€ì¼ */
    .sentence-item.active {
        background-color: #fff5f5;
        /* ì—°í•œ ë¶‰ì€ìƒ‰ ë°°ê²½ */
    }

    .sentence-item.active .original {
        color: #c00;
        font-weight: 700;
    }

    .sentence-item .translation {
        color: #666;
    }

    /* ë°˜ë³µ ì¬ìƒ í™œì„±í™” ì‹œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #repeatBtn.active {
        background-color: #007bff;
        color: white;
    }

    /* ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜í•˜ê¸° ì‰½ë„ë¡ í´ë¦­ ì˜ì—­ í™•ì¥ */
    @media (max-width: 767px) {
        .sentence-item {
            padding: 1rem;
        }
    }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}


{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="d-flex align-items-center">
            <span class="me-2">{{ audio.title }}</span>
        </h1>
        <div>
            {% if not is_in_collection %}
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addToCollectionModal">
                <i class="fas fa-folder-plus"></i> ë³´ê´€í•¨ì— ì¶”ê°€
            </button>
            {% else %}
            <button class="btn btn-secondary" disabled title="ì´ë¯¸ ë³´ê´€í•¨ì— ì¶”ê°€ë˜ì–´ ìˆìŠµë‹ˆë‹¤">
                <i class="fas fa-check"></i> ë³´ê´€í•¨ì— ì¶”ê°€ë¨
            </button>
            {% endif %}
            <a href="{% url 'audio_list' %}" class="btn btn-outline-secondary">ëª©ë¡ìœ¼ë¡œ</a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-1">
                        <strong>ì¹´í…Œê³ ë¦¬:</strong>
                        <select id="categorySelect" class="form-select form-select-sm d-inline-block w-auto ms-2">
                            <option value="0" {% if not audio.category %}selected{% endif %}>
                                ì¹´í…Œê³ ë¦¬ ì—†ìŒ
                            </option>
                            {% for category in categories %}
                            <option value="{{ category.id }}" {% if audio.category == category %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <p class="mb-0"><strong>ìƒì„±ì¼:</strong> {{ audio.created_at|date:"Yë…„ mì›” dì¼ H:i" }}</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <button class="btn btn-danger" id="deleteBtn">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <audio id="audio-player" class="w-100 mb-3">
                {% if audio.audio_file %}
                <source src="{{ audio.audio_file.url }}" type="audio/mpeg">
                {% else %}
                <source src="data:audio/mpeg;base64,{{ audio.audio_data }}" type="audio/mpeg">
                {% endif %}
                ë¸Œë¼ìš°ì €ê°€ ì˜¤ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </audio>
            <div class="d-flex justify-content-center align-items-center mb-2">
                <div class="btn-group me-2">
                    <button id="playPauseBtn" class="btn btn-primary">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="stopBtn" class="btn btn-secondary">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="fas fa-tachometer-alt"></i> <span id="speedLabel">1x</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item speed-option" href="#" data-speed="0.5">0.5x (ëŠë¦¬ê²Œ)</a></li>
                        <li><a class="dropdown-item speed-option" href="#" data-speed="0.75">0.75x</a></li>
                        <li><a class="dropdown-item speed-option active" href="#" data-speed="1">1x (ë³´í†µ)</a></li>
                        <li><a class="dropdown-item speed-option" href="#" data-speed="1.25">1.25x</a></li>
                        <li><a class="dropdown-item speed-option" href="#" data-speed="1.5">1.5x (ë¹ ë¥´ê²Œ)</a></li>
                    </ul>
                </div>
            </div>
            <div class="progress mb-2" style="height: 8px;">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="d-flex justify-content-between small text-muted mb-2">
                <span id="currentTime">0:00</span>
                <span id="duration">0:00</span>
            </div>
            <div class="d-flex justify-content-center align-items-center mt-2">
                <button id="repeatBtn" class="btn btn-outline-primary" disabled>
                    <i class="fas fa-redo"></i> í˜„ì¬ ë¬¸ì¥ ë°˜ë³µ
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">ë¬¸ì¥ ëª©ë¡</h5>
        </div>
        <div class="card-body">
            {% for s in sentences_with_times %}
            <div class="border-bottom py-3 {% if not forloop.last %}mb-3{% endif %} sentence-item"
                data-start="{{ s.start }}" data-end="{{ s.end }}" data-index="{{ forloop.counter0 }}">
                <p class="h5 mb-2 original">{{ s.text }}</p>
                <p class="text-muted mb-0 translation">{{ s.translation }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% include 'partials/add_to_collection_modal.html' %}

{% endblock %}


{% block extra_js %}
<script>
    // ğŸ’¡ 1. ëª¨ë“  Django í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ JavaScript ì „ì—­ CONFIG ê°ì²´ì— ì €ì¥í•©ë‹ˆë‹¤.
    // ì´ëŠ” ì™¸ë¶€ JS íŒŒì¼ì´ Django í…œí”Œë¦¿ ë³€ìˆ˜ë¥¼ ì•ˆì „í•˜ê²Œ ì ‘ê·¼í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
    window.AUDIO_DETAIL_CONFIG = {
        CSRF_TOKEN: "{{ csrf_token }}",
        UPDATE_URL: "{% url 'update_audio' audio.id %}",
        DELETE_URL: "{% url 'delete_audio' audio.id %}",
        AUDIO_LIST_URL: "{% url 'audio_list' %}",
        GET_COLLECTIONS_URL: "{% url 'get_user_collections' %}",
        ADD_TO_COLLECTION_URL: "{% url 'add_to_collection' audio.id %}",
    };
</script>
<script src="{% static 'js/audio_detail.js' %}"></script>
{% endblock %}